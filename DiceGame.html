<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern 3D Cho-Han</title>
    <style>
        :root {
            --primary: #e74c3c;
            --accent: #f1c40f;
            --bg: #1a1a2e;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: white;
        }

        /* UI Layer */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
            box-sizing: border-box;
            z-index: 10;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wallet-card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 1.2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .controls {
            pointer-events: auto;
            align-self: center;
            background: var(--glass);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 400px;
            width: 90%;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.2);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        input {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            width: 100px;
            text-align: center;
            font-size: 1.1rem;
        }

        #result-display {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            height: 40px;
            text-shadow: 0 0 10px var(--accent);
        }

        .status-msg {
            margin-top: 10px;
            color: var(--accent);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="header">
            <h1>丁半博打 <small style="font-size: 0.5em; opacity: 0.7;">3D</small></h1>
            <div class="wallet-card">所持金: <span id="money">1000</span></div>
        </div>

        <div class="controls">
            <div id="result-display"></div>
            
            <div id="bet-phase">
                <input type="number" id="bet-amount" value="100" min="10">
                <p class="status-msg">賭け金を入力して選択してください</p>
                <div class="btn-group">
                    <button onclick="setChoice('odd')">半 (奇数)</button>
                    <button onclick="setChoice('even')">丁 (偶数)</button>
                </div>
            </div>

            <div id="roll-phase" style="display:none;">
                <button id="roll-button" onclick="rollDices()" style="width: 100%; background: #27ae60;">さぁ、振れ！</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let scene, camera, renderer, dices = [], money = 1000;
        let currentBet = 0, currentChoice = "";

        // 3D初期化
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 8);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 照明
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const spot = new THREE.PointLight(0xffffff, 1);
            spot.position.set(5, 10, 5);
            spot.castShadow = true;
            scene.add(spot);

            // 床
            const floorGeo = new THREE.PlaneGeometry(20, 20);
            const floorMat = new THREE.MeshPhongMaterial({ color: 0x0a0a1a });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // サイコロを2個作成
            dices.push(createDice(-1.5));
            dices.push(createDice(1.5));

            animate();
        }

        function createDice(xPos) {
            const group = new THREE.Group();
            const geo = new THREE.BoxGeometry(1, 1, 1);
            
            // 各面のテクスチャを生成（簡易的にCanvasで目を描画）
            const materials = [];
            for (let i = 1; i <= 6; i++) {
                materials.push(new THREE.MeshPhongMaterial({ map: createDiceTexture(i) }));
            }
            
            const mesh = new THREE.Mesh(geo, materials);
            mesh.castShadow = true;
            group.add(mesh);
            group.position.set(xPos, 0.5, 0);
            scene.add(group);
            return group;
        }

        function createDiceTexture(number) {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = number === 1 ? 'red' : 'black';
            
            const dots = {
                1: [[64, 64]],
                2: [[32, 32], [96, 96]],
                3: [[32, 32], [64, 64], [96, 96]],
                4: [[32, 32], [32, 96], [96, 32], [96, 96]],
                5: [[32, 32], [32, 96], [64, 64], [96, 32], [96, 96]],
                6: [[32, 32], [32, 64], [32, 96], [96, 32], [96, 64], [96, 96]]
            };

            dots[number].forEach(dot => {
                ctx.beginPath();
                ctx.arc(dot[0], dot[1], 12, 0, Math.PI * 2);
                ctx.fill();
            });
            
            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        // ゲーム制御
        function setChoice(choice) {
            const amount = parseInt(document.getElementById('bet-amount').value);
            if (amount <= 0 || amount > money) {
                alert("正当な金額を賭けてください");
                return;
            }
            currentBet = amount;
            currentChoice = choice;
            
            document.getElementById('bet-phase').style.display = 'none';
            document.getElementById('roll-phase').style.display = 'block';
            document.getElementById('result-display').textContent = (choice === 'even' ? "丁" : "半") + "に " + amount + " 点";
        }

        function rollDices() {
            const rollBtn = document.getElementById('roll-button');
            rollBtn.disabled = true;

            const res1 = Math.floor(Math.random() * 6) + 1;
            const res2 = Math.floor(Math.random() * 6) + 1;
            const total = res1 + res2;
            const isEven = total % 2 === 0;

            // アニメーション
            let duration = 60;
            let counter = 0;

            const anim = setInterval(() => {
                dices.forEach(d => {
                    d.rotation.x += 0.3;
                    d.rotation.y += 0.2;
                    d.position.y = 0.5 + Math.abs(Math.sin(counter * 0.2)) * 2;
                });
                counter++;

                if (counter > duration) {
                    clearInterval(anim);
                    finalizeRoll(res1, res2, isEven);
                }
            }, 20);
        }

        function finalizeRoll(r1, r2, isEven) {
            // サイコロを結果の面に固定（簡易版）
            const faceRotations = {
                1: [0, 0, 0],
                2: [0, -Math.PI/2, 0],
                3: [Math.PI/2, 0, 0],
                4: [-Math.PI/2, 0, 0],
                5: [0, Math.PI/2, 0],
                6: [Math.PI, 0, 0]
            };

            [r1, r2].forEach((res, i) => {
                dices[i].rotation.set(...faceRotations[res]);
                dices[i].position.y = 0.5;
            });

            const win = (isEven && currentChoice === 'even') || (!isEven && currentChoice === 'odd');
            const resultLabel = isEven ? "丁 (偶数)" : "半 (奇数)";
            
            if (win) {
                money += currentBet;
                document.getElementById('result-display').textContent = `${r1}・${r2} で ${resultLabel}！ 勝ち！`;
                document.getElementById('result-display').style.color = "#f1c40f";
            } else {
                money -= currentBet;
                document.getElementById('result-display').textContent = `${r1}・${r2} で ${resultLabel}… 負け`;
                document.getElementById('result-display').style.color = "#e74c3c";
            }

            updateUI();
        }

        function updateUI() {
            document.getElementById('money').textContent = money;
            document.getElementById('roll-button').disabled = false;
            
            setTimeout(() => {
                if (money <= 0) {
                    alert("破産しました！リロードして再挑戦してください。");
                    location.reload();
                }
                document.getElementById('bet-phase').style.display = 'block';
                document.getElementById('roll-phase').style.display = 'none';
            }, 2000);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
