<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç´™é£›è¡Œæ©Ÿã‚°ãƒ©ã‚¤ãƒ€ãƒ¼</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #87CEEB;
            font-family: 'Arial', sans-serif;
            user-select: none;
            touch-action: none;
        }
        canvas { display: block; }
        
        /* UIãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #ui-top {
            position: absolute;
            top: 10px; width: 100%;
            display: flex; justify-content: space-around;
            color: white; font-weight: bold; text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .gauge-container {
            position: absolute;
            bottom: 20px;
            color: #fff;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 20px;
            pointer-events: none;
        }
        #speed-display { left: 20px; border-left: 5px solid #ffeb3b; }
        #alt-display { right: 20px; border-right: 5px solid #03a9f4; }
        
        #msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(255,255,255,0.9);
            padding: 20px; border-radius: 15px;
            display: none;
        }
        button {
            padding: 10px 20px; font-size: 18px; cursor: pointer;
            background: #ff5722; color: white; border: none; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="ui-top">
        <div id="distance">è·é›¢: 0m</div>
        <div id="hp">HP: 100</div>
        <div id="time">æ®‹ã‚Šæ™‚é–“: 30.0s</div>
    </div>

    <div id="speed-display" class="gauge-container">é€Ÿåº¦: <span id="v-val">0</span> kn</div>
    <div id="alt-display" class="gauge-container">é«˜åº¦: <span id="a-val">0</span> ft</div>

    <div id="msg">
        <h1 id="msg-title">GAME OVER</h1>
        <p id="msg-stats"></p>
        <button onclick="resetGame()">ã‚‚ã†ä¸€åº¦é£›ã°ã™</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * ã‚²ãƒ¼ãƒ è¨­å®š
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msgBox = document.getElementById('msg');

let width, height;
let gameState = 'PLAYING'; // PLAYING, FINISHED

// ç´™é£›è¡Œæ©Ÿã®ãƒ‡ãƒ¼ã‚¿
const plane = {
    x: 100,
    y: 0,
    vx: 5,        // æ°´å¹³é€Ÿåº¦
    vy: 0,        // å‚ç›´é€Ÿåº¦
    angle: 0,     // æ©Ÿé¦–è§’åº¦ï¼ˆãƒ©ã‚¸ã‚¢ãƒ³ï¼‰
    hp: 100,
    time: 30,
    distance: 0,
    width: 40,
    height: 20
};

let items = [];
const GRAVITY = 0.15;
const FRICTION_GROUND = 0.96; // åœ°é¢ã®æ‘©æ“¦
const CONV_KN = 1.94; // m/s -> knots ä¿‚æ•°
const CONV_FT = 3.28; // m -> feet ä¿‚æ•°

/**
 * åˆæœŸåŒ–
 */
function init() {
    resize();
    plane.y = height * 0.3;
    spawnItems();
    requestAnimationFrame(update);
}

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);

/**
 * å…¥åŠ›å‡¦ç†
 */
let isPressingTop = false;
let isPressingBottom = false;

const handleInput = (y, isDown) => {
    if (gameState !== 'PLAYING' || plane.time <= 0) return;
    if (isDown) {
        if (y < height / 2) isPressingTop = true;
        else isPressingBottom = true;
    } else {
        isPressingTop = false;
        isPressingBottom = false;
    }
};

window.addEventListener('mousedown', (e) => handleInput(e.clientY, true));
window.addEventListener('mouseup', () => handleInput(0, false));
window.addEventListener('touchstart', (e) => handleInput(e.touches[0].clientY, true));
window.addEventListener('touchend', () => handleInput(0, false));

/**
 * ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆ
 */
function spawnItems() {
    const types = ['HP', 'TIME', 'SPEED', 'UP', 'SPIKE'];
    for(let i=0; i<15; i++) {
        items.push({
            x: width + Math.random() * 2000,
            y: 50 + Math.random() * (height - 150),
            type: types[Math.floor(Math.random() * types.length)],
            active: true
        });
    }
}

/**
 * ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
 */
function update() {
    ctx.clearRect(0, 0, width, height);
    
    // èƒŒæ™¯ï¼ˆç©ºã¨åœ°é¢ï¼‰
    drawBackground();

    if (gameState === 'PLAYING') {
        handlePhysics();
        handleItems();
    } else {
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å¾Œã®æ‘©æ“¦åœæ­¢å‡¦ç†
        if (plane.y >= height - 40) {
            plane.vx *= FRICTION_GROUND;
            if (plane.vx < 0.1) plane.vx = 0;
        }
    }

    drawPlane();
    updateUI();

    if (plane.vx > 0 || plane.y < height - 40) {
        requestAnimationFrame(update);
    } else {
        showResult();
    }
}

function handlePhysics() {
    // æ™‚é–“æ¶ˆè²»
    if (plane.time > 0) {
        plane.time -= 1/60;
        
        // æ“ä½œ
        if (isPressingTop) {
            plane.angle -= 0.05; // æ©Ÿé¦–ä¸Šã’
            plane.vx -= 0.02;    // ä¸ŠãŒã‚‹ã¨æ¸›é€Ÿ
        } else if (isPressingBottom) {
            plane.angle += 0.05; // æ©Ÿé¦–ä¸‹ã’
            plane.vx += 0.05;    // ä¸‹ãŒã‚‹ã¨åŠ é€Ÿ
        } else {
            // è‡ªå‹•æ°´å¹³å¾©å¸°
            plane.angle *= 0.92;
        }
    } else {
        // æ™‚é–“åˆ‡ã‚Œï¼šæ“ä½œä¸èƒ½ã€æ°´å¹³ã«å›ºå®š
        plane.angle *= 0.8;
        items = []; // ã‚¢ã‚¤ãƒ†ãƒ æ¶ˆå¤±
    }

    // è§’åº¦åˆ¶é™
    plane.angle = Math.max(-0.6, Math.min(0.6, plane.angle));

    // ç‰©ç†è¨ˆç®—
    plane.vy = Math.sin(plane.angle) * plane.vx + GRAVITY;
    plane.y += plane.vy;
    plane.distance += plane.vx / 10;

    // åœ°é¢åˆ¤å®š
    if (plane.y >= height - 40) {
        plane.y = height - 40;
        gameState = 'FINISHED';
    }
    
    // å¤©äº•åˆ¤å®š
    if (plane.y < 0) plane.y = 0;
}

function handleItems() {
    items.forEach(item => {
        if (!item.active) return;
        item.x -= plane.vx;

        // è¡çªåˆ¤å®š
        const dx = item.x - plane.x;
        const dy = item.y - plane.y;
        if (Math.sqrt(dx*dx + dy*dy) < 30) {
            item.active = false;
            applyItem(item.type);
        }

        // ç”»é¢å¤–ã«å‡ºãŸã‚‰å†é…ç½®
        if (item.x < -50) {
            item.x = width + Math.random() * 1000;
            item.y = 50 + Math.random() * (height - 150);
            item.active = true;
        }
        
        drawItem(item);
    });
}

function applyItem(type) {
    switch(type) {
        case 'HP': plane.hp = Math.min(100, plane.hp + 20); break;
        case 'TIME': plane.time += 5; break;
        case 'SPEED': plane.vx += 5; break;
        case 'UP': plane.y -= 100; break;
        case 'SPIKE': 
            plane.hp -= 20; 
            plane.vx *= 0.5; 
            if(plane.hp <= 0) gameState = 'FINISHED';
            break;
    }
}

/**
 * æç”»ç³»
 */
function drawBackground() {
    // åœ°é¢
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(0, height - 30, width, 30);
}

function drawPlane() {
    ctx.save();
    ctx.translate(plane.x, plane.y);
    ctx.rotate(plane.angle);
    
    // ç´™é£›è¡Œæ©Ÿã®å½¢
    ctx.beginPath();
    ctx.moveTo(20, 0);
    ctx.lineTo(-20, -10);
    ctx.lineTo(-10, 0);
    ctx.lineTo(-20, 10);
    ctx.closePath();
    ctx.fillStyle = (plane.hp > 30) ? "white" : "red";
    ctx.fill();
    ctx.stroke();
    ctx.restore();
}

function drawItem(item) {
    ctx.font = "24px Arial";
    let icon = "â“";
    if(item.type === 'HP') icon = "ğŸ©¹";
    if(item.type === 'TIME') icon = "â³";
    if(item.type === 'SPEED') icon = "âš¡";
    if(item.type === 'UP') icon = "ğŸˆ";
    if(item.type === 'SPIKE') icon = "ğŸŒµ";
    ctx.fillText(icon, item.x, item.y);
}

function updateUI() {
    document.getElementById('distance').innerText = `è·é›¢: ${Math.floor(plane.distance)}m`;
    document.getElementById('hp').innerText = `HP: ${Math.max(0, Math.floor(plane.hp))}`;
    document.getElementById('time').innerText = `æ®‹ã‚Šæ™‚é–“: ${Math.max(0, plane.time).toFixed(1)}s`;
    
    // é€Ÿåº¦ï¼ˆãƒãƒƒãƒˆï¼‰ã¨é«˜åº¦ï¼ˆãƒ•ã‚£ãƒ¼ãƒˆï¼‰ã®è¨ˆç®—
    // vxã‚’åŸºæº–ã«å¤‰æ›ã€‚åœ°é¢ã«ç€ã„ã¦ã„ã‚‹ã¨ãã¯é«˜åº¦0ã€‚
    const speedKnots = (plane.vx * CONV_KN).toFixed(1);
    const altitudeFeet = Math.max(0, (height - 40 - plane.y) * CONV_FT / 10).toFixed(0);
    
    document.getElementById('v-val').innerText = speedKnots;
    document.getElementById('a-val').innerText = altitudeFeet;
}

function showResult() {
    msgBox.style.display = 'block';
    document.getElementById('msg-stats').innerHTML = `
        é£›è¡Œè·é›¢: ${Math.floor(plane.distance)} ãƒ¡ãƒ¼ãƒˆãƒ«<br>
        HPæ®‹é‡: ${Math.floor(plane.hp)}
    `;
}

function resetGame() {
    plane.vx = 8; plane.vy = 0; plane.y = height * 0.3;
    plane.angle = 0; plane.hp = 100; plane.time = 30;
    plane.distance = 0;
    gameState = 'PLAYING';
    items = [];
    spawnItems();
    msgBox.style.display = 'none';
}

init();

</script>
</body>
</html>
