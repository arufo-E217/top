<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Å∂„Å£È£õ„Å≥Á¥ôÈ£õË°åÊ©üDX - Ë™øÊï¥Áâà</title>
    <style>
        :root {
            --pop-yellow: #ffeb3b; --pop-blue: #03a9f4; --pop-red: #ff5252;
        }
        body { margin: 0; overflow: hidden; background: #222; display: flex; align-items: center; justify-content: center; height: 100vh; font-family: 'Arial Rounded MT Bold', sans-serif; }
        #game-container { position: relative; width: 100vw; height: 56.25vw; max-width: 177.78vh; max-height: 100vh; background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); overflow: hidden; }
        canvas { width: 100%; height: 100%; display: block; }
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #ui-top { position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-around; }
        .stat-card { background: rgba(255,255,255,0.25); backdrop-filter: blur(5px); padding: 5px 15px; border-radius: 20px; border: 2px solid white; color: white; font-weight: bold; font-size: 1.5vw; }
        .gauge-container { position: absolute; bottom: 20px; color: #fff; background: rgba(0, 0, 0, 0.6); padding: 10px 20px; border-radius: 50px; font-size: 1.8vw; border: 3px solid white; }
        #speed-display { left: 20px; border-color: var(--pop-yellow); }
        #alt-display { left: 220px; border-color: var(--pop-blue); }
        #controls { position: absolute; right: 20px; bottom: 30px; display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .ctrl-btn { width: 7vw; height: 7vw; background: rgba(255, 255, 255, 0.4); border: 4px solid white; border-radius: 50%; color: white; font-size: 3.5vw; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
        #skip-btn { position: absolute; top: 20px; right: 20px; padding: 10px 20px; background: var(--pop-yellow); border: 3px solid white; border-radius: 10px; font-weight: bold; cursor: pointer; display: none; pointer-events: auto; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); color: white; text-align: center; pointer-events: auto; }
        button.main-btn { padding: 15px 40px; font-size: 2vw; background: var(--pop-red); color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 5px 0 #c62828; }
        #ff-indicator { position: absolute; bottom: 100px; left: 20px; color: var(--pop-yellow); font-size: 2vw; font-weight: bold; text-shadow: 2px 2px 4px black; display: none; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ff-indicator">‚è© Êó©ÈÄÅ„Çä‰∏≠...</div>
        <div class="ui-layer">
            <div id="ui-top">
                <div class="stat-card" id="distance">Ë∑ùÈõ¢: 0m</div>
                <div class="stat-card" id="hp">HP: 100</div>
                <div class="stat-card" id="time">ÊÆã„ÇäÊôÇÈñì: 30s</div>
            </div>
            <div id="speed-display" class="gauge-container">SPD: <span id="v-val">0</span> kn</div>
            <div id="alt-display" class="gauge-container">ALT: <span id="a-val">0</span> ft</div>
        </div>
        <div id="controls"><div class="ctrl-btn" id="btn-up">‚Üë</div><div class="ctrl-btn" id="btn-down">‚Üì</div></div>
        <div id="skip-btn" onclick="startFastForward()">ÁùÄÂú∞„Åæ„ÅßÊó©ÈÄÅ„Çä ‚è©</div>
        <div id="start-screen" class="overlay"><h1 style="font-size: 4vw;">POP GLIDER</h1><button class="main-btn" onclick="startGame()">START</button></div>
        <div id="msg" class="overlay" style="display: none;"><h1 id="res-title">FINISH!</h1><p id="msg-stats" style="font-size: 2vw;"></p><button class="main-btn" onclick="location.reload()">RETRY</button></div>
    </div>

<script>
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const V_WIDTH = 1920, V_HEIGHT = 1080;
canvas.width = V_WIDTH; canvas.height = V_HEIGHT;

let gameState = 'WAITING', clouds = [], buildings = [], items = [], timeOverTick = 0;
let isFastForwarding = false, ffElapsedFrames = 0;

const plane = { x: 250, y: 300, vx: 12, vy: 0, angle: 0, hp: 100, time: 30, distance: 0 };
const GRAVITY = 0.15, FRICTION = 0.97;

// --- „ÄêÂ§âÊõ¥2„Äë„Ç¢„Ç§„ÉÜ„É†„ÅÆÂäπÊûúË®≠ÂÆö„Çí‰∏ÄÊã¨ÁÆ°ÁêÜ ---
const ITEM_CONFIG = {
    HP:    { hpGain: 20, timeGain: 0, vxGain: 0, yGain: 0, vxMult: 1 },
    TIME:  { hpGain: 0,  timeGain: 6, vxGain: 0, yGain: 0, vxMult: 1 },
    SPEED: { hpGain: 0,  timeGain: 0, vxGain: 8, yGain: 0, vxMult: 1.2 },
    UP:    { hpGain: 0,  timeGain: 0, vxGain: 0, yGain: -250, vxMult: 1 },
    SPIKE: { hpGain: -30, timeGain: 0, vxGain: 0, yGain: 0, vxMult: 0.75 }
};

for(let i=0; i<6; i++) spawnBuilding(i * (V_WIDTH/5));

function spawnItem() {
    if (gameState !== 'PLAYING') return; 
    const types = Object.keys(ITEM_CONFIG); 
    items.push({ 
        x: V_WIDTH + 200, 
        y: 150 + Math.random() * (V_HEIGHT - 400), 
        type: types[Math.floor(Math.random()*types.length)], 
        active: true
    });
}

function spawnBuilding(xPos = V_WIDTH + 200) {
    buildings.push({
        x: xPos, w: 150 + Math.random() * 200, h: 200 + Math.random() * 400,
        color: `hsl(${200 + Math.random()*20}, 30%, ${30 + Math.random()*20}%)`
    });
}

function startGame() { document.getElementById('start-screen').style.display = 'none'; gameState = 'PLAYING'; requestAnimationFrame(update); }

let isUp = false, isDown = false;
const setUp = (e) => { e.preventDefault(); if(gameState === 'PLAYING') isUp = true; };
const setDown = (e) => { e.preventDefault(); if(gameState === 'PLAYING') isDown = true; };
const release = () => { isUp = false; isDown = false; };

document.getElementById('btn-up').onmousedown = document.getElementById('btn-up').ontouchstart = setUp;
document.getElementById('btn-down').onmousedown = document.getElementById('btn-down').ontouchstart = setDown;
window.onmouseup = window.ontouchend = release;

function update() {
    ctx.clearRect(0, 0, V_WIDTH, V_HEIGHT);
    
    let timeScale = 1;
    if (isFastForwarding) {
        ffElapsedFrames++;
        timeScale = Math.min(5, 1 + (ffElapsedFrames / 60) * 0.5);
        if ((V_HEIGHT - 100 - plane.y) * 0.328 < 15) {
            isFastForwarding = false;
            document.getElementById('ff-indicator').style.display = 'none';
        }
    }

    for (let t = 0; t < timeScale; t++) {
        runPhysics();
    }

    drawWorld();
    drawPlane();
    updateUI();

    if (plane.vx > 0.01 || plane.y < V_HEIGHT - 100 || gameState === 'PLAYING') {
        requestAnimationFrame(update);
    }
}

function runPhysics() {
    // --- „ÄêÂ§âÊõ¥1„ÄëÂãïÁöÑ„Å™Á©∫Ê∞óÊäµÊäó„ÅÆË®àÁÆó (5kt„Äú60kt) ---
    const speedKt = plane.vx * 1.94;
    let currentAirRes = 0;
    if (speedKt <= 5) {
        currentAirRes = 0;
    } else if (speedKt >= 60) {
        currentAirRes = 0.003;
    } else {
        currentAirRes = ((speedKt - 5) / (60 - 5)) * 0.003;
    }

    if (gameState === 'PLAYING') {
        plane.time -= 1/60;
        if (plane.time <= 0) {
            plane.time = 0;
            gameState = 'TIMEUP';
            isUp = false; isDown = false;
            items = [];
        }

        if (isUp) { plane.angle -= 0.04; plane.vx -= 0.04; }
        else if (isDown) { plane.angle += 0.04; plane.vx += 0.05; }
        else { plane.angle *= 0.96; }

        plane.vx = Math.max(0, plane.vx - currentAirRes);
        plane.angle = Math.max(-0.7, Math.min(0.7, plane.angle));
        plane.vy = Math.sin(plane.angle) * plane.vx + GRAVITY;
        plane.y += plane.vy;
        plane.distance += plane.vx / 10;

        if (plane.y >= V_HEIGHT - 100) { plane.y = V_HEIGHT - 100; gameState = 'FINISHED'; }
        if (plane.y < 0) plane.y = 0;
        
        if (items.length < 6 && Math.random() < 0.02) spawnItem();
        handleItems();

    } else if (gameState === 'TIMEUP') {
        timeOverTick++;
        if (timeOverTick > 180 && !isFastForwarding) document.getElementById('skip-btn').style.display = 'block';
        
        plane.angle *= 0.98;
        plane.vx = Math.max(0, plane.vx - currentAirRes);
        plane.vy = Math.sin(plane.angle) * plane.vx + GRAVITY;
        plane.y += plane.vy;
        plane.distance += plane.vx / 10;
        
        if (plane.y >= V_HEIGHT - 100) {
            plane.y = V_HEIGHT - 100;
            gameState = 'FINISHED';
        }
    } else if (gameState === 'FINISHED') {
        plane.vx *= FRICTION;
        plane.distance += plane.vx / 10;
        if (plane.vx < 0.1) { plane.vx = 0; showResult(); }
    }
}

function handleItems() {
    for (let i = items.length - 1; i >= 0; i--) {
        let it = items[i];
        // „Ç¢„Ç§„ÉÜ„É†„ÅØÂ∏∏„Å´Â∑¶„Å´ÊµÅ„Çå„Çã (+5)
        it.x -= (plane.vx + 5); 
        if (it.active && Math.hypot(it.x - plane.x, it.y - plane.y) < 50) {
            it.active = false;
            // --- „ÄêÂ§âÊõ¥2„Äë„Ç¢„Ç§„ÉÜ„É†ÂäπÊûú„ÅÆÈÅ©Áî® ---
            const cfg = ITEM_CONFIG[it.type];
            if (cfg) {
                plane.hp = Math.max(0, Math.min(100, plane.hp + cfg.hpGain));
                plane.time += cfg.timeGain;
                plane.vx = (plane.vx + cfg.vxGain) * cfg.vxMult;
                plane.y += cfg.yGain;
                if(plane.hp <= 0) gameState = 'FINISHED';
            }
        }
        if (it.x < -100) items.splice(i, 1);
    }
}

function startFastForward() {
    isFastForwarding = true;
    ffElapsedFrames = 0;
    document.getElementById('skip-btn').style.display = 'none';
    document.getElementById('ff-indicator').style.display = 'block';
}

function drawItem(it) {
    const color = {HP:'#4caf50', TIME:'#2196f3', SPEED:'#ffeb3b', UP:'#e91e63', SPIKE:'#f44336'}[it.type];
    const icon = {HP:'ü©π', TIME:'‚è≥', SPEED:'‚ö°', UP:'üéà', SPIKE:'üåµ'}[it.type];
    ctx.save();
    ctx.beginPath(); ctx.arc(it.x, it.y, 35, 0, Math.PI*2); ctx.fillStyle = "white"; ctx.fill();
    ctx.strokeStyle = color; ctx.lineWidth = 5; ctx.stroke();
    ctx.font = "40px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(icon, it.x, it.y + 4); ctx.restore();
}

function drawWorld() {
    // Èõ≤ÔºöÂ∏∏„Å´Â∑¶„Å´ÊµÅ„Çå„Çã (+1)
    if (clouds.length < 8) clouds.push({x: V_WIDTH+200, y: Math.random()*300, s: 0.5+Math.random()});
    clouds.forEach((c, i) => {
        c.x -= (plane.vx * 0.2 + 1);
        ctx.fillStyle = "rgba(255,255,255,0.5)";
        ctx.beginPath(); ctx.ellipse(c.x, c.y, 80*c.s, 40*c.s, 0, 0, 7); ctx.fill();
        if (c.x < -300) clouds.splice(i, 1);
    });

    // „Éì„É´Ôºö„Äê‰øÆÊ≠£„ÄëÈ£õË°åÊ©ü„ÅÆÈÄüÂ∫¶ vx „Å´„ÅÆ„ÅøÂêåÊúüÔºà0kt„Å™„ÇâÊ≠¢„Åæ„ÇãÔºâ
    if (buildings.length < 8) spawnBuilding();
    buildings.forEach((b, i) => {
        b.x -= (plane.vx * 0.8); 
        ctx.fillStyle = b.color;
        ctx.fillRect(b.x, V_HEIGHT - b.h - 80, b.w, b.h);
        ctx.fillStyle = "rgba(255,255,255,0.1)";
        for(let j=0; j<3; j++) ctx.fillRect(b.x + 20 + j*40, V_HEIGHT - b.h + 20, 20, 100);
        if (b.x + b.w < -200) buildings.splice(i, 1);
    });

    ctx.fillStyle = "#388E3C"; ctx.fillRect(0, V_HEIGHT - 80, V_WIDTH, 80);
    ctx.fillStyle = "#2E7D32";
    for(let i=0; i<V_WIDTH+100; i+=100) {
        let offset = (plane.distance * 10) % 100;
        ctx.fillRect(i - offset, V_HEIGHT - 80, 50, 10);
    }
    items.forEach(it => { if(it.active) drawItem(it); });
}

function drawPlane() {
    ctx.save(); ctx.translate(plane.x, plane.y); ctx.rotate(plane.angle);
    ctx.fillStyle = "rgba(0,0,0,0.2)";
    ctx.beginPath(); ctx.ellipse(0, (V_HEIGHT - 100 - plane.y), 40, 10, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.moveTo(50, 0); ctx.lineTo(-40, -25); ctx.lineTo(-20, 0); ctx.lineTo(-40, 25); ctx.closePath();
    ctx.fillStyle = "white"; ctx.fill(); ctx.strokeStyle = "#333"; ctx.lineWidth = 4; ctx.stroke();
    ctx.restore();
}

function updateUI() {
    document.getElementById('distance').innerText = `Ë∑ùÈõ¢: ${Math.floor(plane.distance)}m`;
    document.getElementById('hp').innerText = `HP: ${Math.max(0, Math.round(plane.hp))}`;
    document.getElementById('time').innerText = `ÊÆã„ÇäÊôÇÈñì: ${plane.time.toFixed(1)}s`;
    document.getElementById('v-val').innerText = (plane.vx * 1.94).toFixed(1);
    document.getElementById('a-val').innerText = Math.max(0, (V_HEIGHT - 100 - plane.y) * 0.328).toFixed(0);
}

function showResult() {
    if(document.getElementById('msg').style.display === 'flex') return;
    document.getElementById('msg').style.display = 'flex';
    document.getElementById('msg-stats').innerHTML = `È£õË°åË∑ùÈõ¢: <strong>${Math.floor(plane.distance)} m</strong>`;
    document.getElementById('skip-btn').style.display = 'none';
}
</script>
</body>
</html>
